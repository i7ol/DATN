<div class="min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8">
  <div class="max-w-7xl mx-auto">
    <!-- Loading Overlay -->
    <div
      *ngIf="isLoading"
      class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50"
    >
      <div class="text-center">
        <div
          class="animate-spin rounded-full h-12 w-12 border-b-2 border-black mx-auto"
        ></div>
        <p class="mt-4 text-gray-600">ƒêang t·∫£i th√¥ng tin...</p>
      </div>
    </div>

    <!-- Validation Alert -->
    <div
      *ngIf="formTouched && !isFormValid()"
      class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-xl"
    >
      <div class="flex items-center">
        <svg
          class="h-5 w-5 text-yellow-400 mr-2"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            fill-rule="evenodd"
            d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
            clip-rule="evenodd"
          />
        </svg>
        <p class="text-sm text-yellow-700">
          Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc (*) tr∆∞·ªõc khi ƒë·∫∑t h√†ng
        </p>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Column - Main Content -->
      <div class="lg:col-span-2 space-y-8">
        <!-- Customer Information Card -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4 pb-3 border-b">
            üì¶ Th√¥ng tin nh·∫≠n h√†ng
          </h2>

          <form [formGroup]="checkoutForm" class="space-y-4">
            <!-- Email -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Email *</label
              >
              <input
                type="email"
                formControlName="email"
                [class]="
                  'w-full px-4 py-2.5 border rounded-lg focus:ring-2 focus:ring-black focus:border-transparent transition ' +
                  getValidationClass('email')
                "
                placeholder="your@email.com"
              />
              <div
                *ngIf="formTouched && checkoutForm.get('email')?.invalid"
                class="mt-1 text-sm text-red-600"
              >
                <div *ngIf="checkoutForm.get('email')?.errors?.required">
                  Email l√† b·∫Øt bu·ªôc
                </div>
                <div *ngIf="checkoutForm.get('email')?.errors?.email">
                  Email kh√¥ng h·ª£p l·ªá
                </div>
              </div>
            </div>

            <!-- Name & Phone -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >H·ªç v√† t√™n *</label
                >
                <input
                  type="text"
                  formControlName="name"
                  [class]="
                    'w-full px-4 py-2.5 border rounded-lg focus:ring-2 focus:ring-black focus:border-transparent transition ' +
                    getValidationClass('name')
                  "
                  placeholder="Nguy·ªÖn VƒÉn A"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >S·ªë ƒëi·ªán tho·∫°i *</label
                >
                <input
                  type="tel"
                  formControlName="phone"
                  [class]="
                    'w-full px-4 py-2.5 border rounded-lg focus:ring-2 focus:ring-black focus:border-transparent transition ' +
                    getValidationClass('phone')
                  "
                  placeholder="0912 345 678"
                />
              </div>
            </div>

            <!-- Address fields -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >T·ªânh/Th√†nh *</label
                >
                <select
                  formControlName="province"
                  [class]="
                    'w-full px-4 py-2.5 border rounded-lg focus:ring-2 focus:ring-black focus:border-transparent transition bg-white ' +
                    getValidationClass('province')
                  "
                >
                  <option value="">Ch·ªçn t·ªânh/th√†nh</option>
                  <option *ngFor="let p of provinces" [value]="p.code">
                    {{ p.name }}
                  </option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >Qu·∫≠n/Huy·ªán *</label
                >
                <select
                  formControlName="district"
                  [class]="
                    'w-full px-4 py-2.5 border rounded-lg focus:ring-2 focus:ring-black focus:border-transparent transition bg-white ' +
                    getValidationClass('district')
                  "
                >
                  <option value="">Ch·ªçn qu·∫≠n/huy·ªán</option>
                  <option *ngFor="let d of districts" [value]="d.code">
                    {{ d.name }}
                  </option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >Ph∆∞·ªùng/X√£ *</label
                >
                <select
                  formControlName="ward"
                  [class]="
                    'w-full px-4 py-2.5 border rounded-lg focus:ring-2 focus:ring-black focus:border-transparent transition bg-white ' +
                    getValidationClass('ward')
                  "
                >
                  <option value="">Ch·ªçn ph∆∞·ªùng/x√£</option>
                  <option *ngFor="let w of wards" [value]="w.code">
                    {{ w.name }}
                  </option>
                </select>
              </div>
            </div>

            <!-- Address Detail -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >ƒê·ªãa ch·ªâ chi ti·∫øt *</label
              >
              <textarea
                formControlName="addressDetail"
                rows="2"
                [class]="
                  'w-full px-4 py-2.5 border rounded-lg focus:ring-2 focus:ring-black focus:border-transparent transition resize-none ' +
                  getValidationClass('addressDetail')
                "
                placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng..."
              ></textarea>
            </div>

            <!-- Note -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Ghi ch√∫ (t√πy ch·ªçn)</label
              >
              <textarea
                formControlName="note"
                rows="2"
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent transition resize-none"
                placeholder="Ghi ch√∫ th√™m v·ªÅ ƒë∆°n h√†ng..."
              ></textarea>
            </div>
          </form>
        </div>

        <!-- Shipping Methods Card -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4 pb-3 border-b">
            üöö V·∫≠n chuy·ªÉn
          </h2>

          <!-- Shipping list -->
          <div class="space-y-3">
            <div
              *ngFor="let method of shippingMethods"
              class="flex items-start p-3 rounded-xl border cursor-pointer transition"
              [class.border-black]="selectedShippingMethodId === method.id"
              [class.border-gray-200]="selectedShippingMethodId !== method.id"
              (click)="onShippingMethodChange(method.id)"
            >
              <input
                type="radio"
                class="mt-1 h-4 w-4 text-black focus:ring-black border-gray-300"
                name="shippingMethod"
                [checked]="selectedShippingMethodId === method.id"
              />

              <div class="ml-3 flex-1">
                <div class="flex justify-between">
                  <div>
                    <p class="font-medium text-gray-900">{{ method.name }}</p>
                    <p class="text-sm text-gray-500 mt-1">
                      {{ method.description }}
                    </p>

                    <p
                      *ngIf="method.estimatedDays"
                      class="text-xs text-gray-400 mt-1"
                    >
                      D·ª± ki·∫øn giao: {{ method.estimatedDays }}
                    </p>
                  </div>

                  <span class="font-semibold text-gray-900">
                    {{ formatCurrency(method.fee) }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Methods Card - GI·ªÆ NGUY√äN GIAO DI·ªÜN -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4 pb-3 border-b">
            üí≥ Thanh to√°n
          </h2>

          <div class="space-y-4">
            <div class="flex items-start">
              <input
                type="radio"
                name="paymentMethod"
                id="payment-cod"
                [checked]="selectedPaymentMethod === 'COD'"
                (change)="onPaymentMethodChange('COD')"
                class="mt-1 h-4 w-4 text-black focus:ring-black border-gray-300"
              />
              <label for="payment-cod" class="ml-3 flex-1 cursor-pointer">
                <div class="flex items-center justify-between">
                  <div>
                    <span class="font-medium text-gray-900"
                      >üí∞ Thanh to√°n khi giao h√†ng (COD)</span
                    >
                    <p class="text-sm text-gray-500 mt-1">
                      B·∫°n ch·ªâ ph·∫£i thanh to√°n khi nh·∫≠n ƒë∆∞·ª£c h√†ng
                    </p>
                  </div>
                </div>
              </label>
            </div>

            <div class="flex items-start">
              <input
                type="radio"
                name="paymentMethod"
                id="payment-qr"
                [checked]="selectedPaymentMethod === 'QR'"
                (change)="onPaymentMethodChange('QR')"
                class="mt-1 h-4 w-4 text-black focus:ring-black border-gray-300"
              />
              <label for="payment-qr" class="ml-3 flex-1 cursor-pointer">
                <div class="flex items-center justify-between">
                  <div>
                    <span class="font-medium text-gray-900"
                      >üì± Thanh to√°n qua VNPAY QR</span
                    >
                    <p class="text-sm text-gray-500 mt-1">
                      Qu√©t m√£ QR ƒë·ªÉ thanh to√°n ngay qua VNPAY
                    </p>
                  </div>
                </div>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Order Summary -->
      <div class="lg:col-span-1">
        <div
          class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 sticky top-8"
        >
          <h2 class="text-lg font-semibold text-gray-900 mb-4 pb-3 border-b">
            ƒê∆°n h√†ng ({{ cartItemsCount }} s·∫£n ph·∫©m)
          </h2>

          <!-- Cart Items v·ªõi ·∫£nh v√† th√¥ng tin size/color -->
          <div class="space-y-4 mb-6" *ngIf="cartItems.length > 0">
            <div
              *ngFor="let item of cartItems"
              class="flex items-start space-x-3"
            >
              <!-- Hi·ªÉn th·ªã ·∫£nh s·∫£n ph·∫©m -->
              <div
                class="flex-shrink-0 w-16 h-16 bg-gray-100 rounded-lg overflow-hidden"
              >
                <img
                  *ngIf="item.imageUrl"
                  [src]="item.imageUrl"
                  [alt]="item.productName || 'S·∫£n ph·∫©m'"
                  class="w-full h-full object-cover"
                />
                <div
                  *ngIf="!item.imageUrl"
                  class="w-full h-full flex items-center justify-center bg-gray-200"
                >
                  <span class="text-gray-400 text-xs">IMG</span>
                </div>
              </div>
              <div class="flex-1 min-w-0">
                <h4 class="text-sm font-medium text-gray-900 truncate">
                  {{ item.productName || "S·∫£n ph·∫©m kh√¥ng t√™n" }}
                </h4>

                <!-- HI·ªÇN TH·ªä SIZE V√Ä COLOR -->
                <div class="flex items-center space-x-3 mt-1">
                  <!-- Size Badge -->
                  <div *ngIf="item.size" class="flex items-center">
                    <span class="text-xs text-gray-500">Size:</span>
                    <span
                      class="ml-1 text-xs font-medium text-gray-700 px-2 py-0.5 bg-gray-100 rounded"
                    >
                      {{ item.sizeText || item.size }}
                    </span>
                  </div>

                  <!-- Color Badge v·ªõi m√†u -->
                  <div *ngIf="item.color" class="flex items-center">
                    <span class="text-xs text-gray-500">M√†u:</span>
                    <div class="flex items-center ml-1">
                      <div
                        class="w-4 h-4 rounded-full border border-gray-300 mr-1"
                        [style.background-color]="item.colorCode"
                        [title]="item.colorText || item.color"
                      ></div>
                      <span
                        class="text-xs font-medium text-gray-700 px-2 py-0.5 bg-gray-100 rounded"
                      >
                        {{ item.colorText || item.color }}
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Quantity and Price -->
                <div class="flex items-center justify-between mt-2">
                  <p class="text-sm text-gray-500">
                    S·ªë l∆∞·ª£ng: {{ item.quantity || 0 }}
                  </p>
                  <p class="text-sm font-semibold text-gray-900">
                    {{
                      formatCurrency((item.price || 0) * (item.quantity || 0))
                    }}
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- N·∫øu gi·ªè h√†ng tr·ªëng -->
          <div *ngIf="cartItems.length === 0" class="text-center py-8">
            <div class="text-gray-400 mb-2">
              <svg
                class="w-12 h-12 mx-auto"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"
                ></path>
              </svg>
            </div>
            <p class="text-gray-500">Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</p>
            <a
              [routerLink]="['/products']"
              class="inline-block mt-2 text-sm text-blue-600 hover:text-blue-800"
            >
              Ti·∫øp t·ª•c mua s·∫Øm ‚Üí
            </a>
          </div>

          <!-- Discount Code -->
          <div class="mb-4" *ngIf="cartItems.length > 0">
            <div class="flex space-x-2">
              <input
                type="text"
                [(ngModel)]="discountCode"
                (keyup.enter)="applyDiscount()"
                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent transition"
                placeholder="Nh·∫≠p m√£ gi·∫£m gi√°"
                [disabled]="discountApplied"
              />
              <button
                *ngIf="!discountApplied"
                (click)="applyDiscount()"
                class="px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                [disabled]="!discountCode.trim()"
              >
                √Åp d·ª•ng
              </button>
              <button
                *ngIf="discountApplied"
                (click)="removeDiscount()"
                class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition font-medium"
              >
                H·ªßy
              </button>
            </div>
            <div
              *ngIf="discountApplied"
              class="mt-2 p-2 bg-green-50 border border-green-200 rounded-lg"
            >
              <p class="text-sm text-green-700">
                ‚úÖ ƒê√£ √°p d·ª•ng m√£ gi·∫£m gi√°
                <span class="font-semibold">{{ discountCode }}</span>
                <span *ngIf="discountPercentage > 0">
                  (Gi·∫£m {{ discountPercentage }}%)</span
                >
                <span *ngIf="discountCode === 'FREESHIP'">
                  (Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn)</span
                >
              </p>
            </div>
          </div>

          <!-- Order Summary -->
          <div
            class="space-y-3 border-t border-gray-200 pt-4"
            *ngIf="cartItems.length > 0"
          >
            <div class="flex justify-between">
              <span class="text-gray-600">T·∫°m t√≠nh</span>
              <span class="font-medium">{{
                formatCurrency(orderSummary.subtotal)
              }}</span>
            </div>

            <div class="flex justify-between">
              <span class="text-gray-600">Ph√≠ v·∫≠n chuy·ªÉn</span>
              <span class="font-medium">{{
                formatCurrency(orderSummary.shipping)
              }}</span>
              <span
                *ngIf="orderSummary.shipping === 0"
                class="text-xs text-green-600 ml-2"
                >(Mi·ªÖn ph√≠)</span
              >
            </div>

            <div
              *ngIf="discountApplied && orderSummary.discount > 0"
              class="flex justify-between text-green-600"
            >
              <span>Gi·∫£m gi√°</span>
              <span class="font-medium"
                >-{{ formatCurrency(orderSummary.discount) }}</span
              >
            </div>

            <div
              class="flex justify-between text-lg font-semibold pt-3 border-t border-gray-200"
            >
              <span>T·ªïng c·ªông</span>
              <span class="text-gray-900">{{
                formatCurrency(orderSummary.total)
              }}</span>
            </div>
          </div>

          <!-- Checkout Button -->
          <button
            (click)="submitOrder()"
            [disabled]="
              isSubmitting ||
              cartItemsCount === 0 ||
              !isFormValid() ||
              isProcessingPayment
            "
            class="w-full mt-6 py-3.5 bg-black text-white rounded-xl font-semibold hover:bg-gray-900 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
          >
            <span
              *ngIf="isSubmitting || isProcessingPayment"
              class="flex items-center"
            >
              <svg
                class="animate-spin -ml-1 mr-2 h-4 w-4 text-white"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                ></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
              {{
                isProcessingPayment
                  ? "ƒêang x·ª≠ l√Ω thanh to√°n..."
                  : "ƒêang t·∫°o ƒë∆°n h√†ng..."
              }}
            </span>
            <span *ngIf="!isSubmitting && !isProcessingPayment">
              {{
                isFormValid() ? "ƒê·∫∂T H√ÄNG" : "VUI L√íNG ƒêI·ªÄN ƒê·∫¶Y ƒê·ª¶ TH√îNG TIN"
              }}
            </span>
          </button>

          <!-- Back to Cart -->
          <a
            [routerLink]="['/cart']"
            class="block w-full mt-3 py-2.5 text-center text-gray-600 border border-gray-300 rounded-xl font-medium hover:bg-gray-50 transition"
          >
            ‚Üê Quay v·ªÅ gi·ªè h√†ng
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
